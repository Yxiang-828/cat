<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bugis System - Proper CLD</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre-d3/0.6.4/dagre-d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f6f9;
        }

        svg {
            width: 100vw;
            height: 100vh;
        }

        text {
            font-weight: 500;
            font-family: 'Segoe UI', sans-serif;
            font-size: 14px;
            fill: #222;
        }

        .node rect {
            stroke-width: 2px;
            rx: 6;
            ry: 6;
            transition: 0.3s;
        }

        .group-0 rect {
            fill: #e1f5fe;
            stroke: #0288d1;
        }

        .group-2 rect {
            fill: #e8f5e9;
            stroke: #388e3c;
        }

        .group-3 rect {
            fill: #fce4ec;
            stroke: #c2185b;
        }

        .group-4 rect {
            fill: #ede7f6;
            stroke: #512da8;
        }

        .edgePath path {
            stroke-width: 2.5px !important;
            fill: none !important;
            opacity: 1;
            transition: 0.3s;
        }

        .positive>path {
            stroke: #2ca02c !important;
        }

        .negative>path {
            stroke: #d62728 !important;
        }

        .edgePath.positive marker path {
            fill: #2ca02c !important;
        }

        .edgePath.negative marker path {
            fill: #d62728 !important;
        }

        .fade {
            opacity: 0.1 !important;
        }

        .highlight path {
            stroke-width: 5px !important;
            opacity: 1 !important;
        }

        .node-active rect {
            stroke-width: 4px !important;
            opacity: 1 !important;
        }

        /* Enhanced label visibility to prevent visual overlap */
        .edgeLabel div {
            background-color: rgba(255, 255, 255, 0.95);
            border: 2px solid #aaa;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            opacity: 1;
            transition: 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .label-pos {
            color: #2ca02c;
        }

        .label-neg {
            color: #d62728;
        }

        .highlight-label div {
            opacity: 1 !important;
            border-color: #000 !important;
            transform: scale(1.15);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10;
            width: 260px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            font-size: 12px;
            color: #444;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            margin-right: 10px;
        }

        button {
            width: 100%;
            margin-top: 8px;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
            color: white;
            transition: 0.2s;
        }

        button:hover {
            opacity: 0.8;
        }
    </style>
</head>

<body>
    <div id="controls">
        <h3 style="margin: 0 0 10px 0; font-size: 15px; color:#222;">Stakeholder Domains</h3>
        <div class="legend-item">
            <div class="legend-color" style="background: #e1f5fe; border: 1px solid #0288d1;"></div>Policy & Governance
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #e8f5e9; border: 1px solid #388e3c;"></div>Commercial &
            Religious
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #fce4ec; border: 1px solid #c2185b;"></div>Urban Environment
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ede7f6; border: 1px solid #512da8;"></div>Resident Well-Being
        </div>

        <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
        <b style="font-size: 13px;">Isolate Pathways</b>
        <button style="background:#444" onclick="showAll()">Show All</button>
        <button style="background:#d62728" onclick="isolate('noise')">Noise Pollution Loop</button>
        <button style="background:#1976d2" onclick="isolate('air')">Air Pollution Loop</button>
        <button style="background:#2ca02c" onclick="isolate('spirit')">Community Spirit Path</button>

        <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
        <button id="exportBtn" onclick="downloadPNG()" style="background:#512da8;">Export High-Res PNG</button>
    </div>

    <svg>
        <g />
    </svg>

    <script>
        var g = new dagreD3.graphlib.Graph({ multigraph: true }).setGraph({
            rankdir: 'TB',
            nodesep: 80,
            ranksep: 120,
            align: 'DL'
        });

        const nodes = [
            { id: "NEA", label: "Freq. of NEA Interventions", group: 0 },
            { id: "RelSites", label: "Number of Religious Sites", group: 2 },
            { id: "Shops", label: "Density of Commercial Shops", group: 2 },
            { id: "RelEvents", label: "Freq. of Religious Events", group: 2 },
            { id: "Lorries", label: "Volume of Delivery Lorries", group: 3 },
            { id: "Traffic", label: "Traffic Volume", group: 3 },
            { id: "Burning", label: "Volume of Ceremonial Burning", group: 3 },
            { id: "Celebration", label: "Freq. of Large Celebrations", group: 3 },
            { id: "Noise", label: "Level of Noise Pollution", group: 3 },
            { id: "Air", label: "Level of Air Pollution", group: 3 },
            { id: "Psych", label: "Level of Psychological Health", group: 4 },
            { id: "Phys", label: "Level of Physical Health", group: 4 },
            { id: "Identity", label: "Sense of Identity & Belonging", group: 4 },
            { id: "Spirit", label: "Level of Community Spirit", group: 4 },
            { id: "QoL", label: "Resident Quality of Life", group: 4 },
            { id: "Comp", label: "Freq. of Resident Complaints", group: 4 }
        ];

        nodes.forEach(n => {
            g.setNode(n.id, { label: n.label, class: "group-" + n.group, id: "node-" + n.id, paddingLeft: 15, paddingRight: 15, paddingTop: 10, paddingBottom: 10 });
        });

        function addE(s, t, p, sys) {
            let labelHtml = `<div><span class="${p === '+' ? 'label-pos' : 'label-neg'}">${p}</span></div>`;
            g.setEdge(s, t, {
                labelType: "html",
                label: labelHtml,
                class: (p === "+" ? "positive " : "negative ") + sys,
                curve: d3.curveBasis
            });
        }

        addE("QoL", "Comp", "-", "noise air");
        addE("Comp", "NEA", "+", "noise air");
        addE("RelSites", "Shops", "+", "noise air");
        addE("RelSites", "RelEvents", "+", "noise air spirit");
        addE("Shops", "Lorries", "+", "noise air");
        addE("RelEvents", "Lorries", "+", "noise air");
        addE("Lorries", "Traffic", "+", "noise air");
        addE("RelEvents", "Burning", "+", "air");
        addE("Burning", "Air", "+", "air");
        addE("Traffic", "Air", "+", "air");
        addE("Air", "Phys", "-", "air");
        addE("Phys", "QoL", "+", "air");
        addE("NEA", "Air", "-", "air");
        addE("RelEvents", "Celebration", "+", "noise");
        addE("Celebration", "Noise", "+", "noise");
        addE("Traffic", "Noise", "+", "noise");
        addE("Noise", "Psych", "-", "noise");
        addE("Psych", "QoL", "+", "noise");
        addE("NEA", "Noise", "-", "noise");
        addE("RelEvents", "Identity", "+", "spirit");
        addE("Identity", "Spirit", "+", "spirit");
        addE("Spirit", "QoL", "+", "spirit");

        var render = new dagreD3.render();
        var svg = d3.select("svg"), inner = svg.select("g");
        render(inner, g);

        // Vector Math Label Repositioning with Dynamic Staggering
        var targetCounts = {};

        inner.selectAll("g.edgeLabel").each(function (e) {
            var edge = g.edge(e);

            if (edge.points && edge.points.length >= 2) {
                var pts = edge.points;
                var p1 = pts[pts.length - 2];
                var p2 = pts[pts.length - 1]; // Exact arrowhead intersection

                var angle = Math.atan2(p2.y - p1.y, p2.x - p1.x);

                // Track how many edges share this exact target node
                if (!targetCounts[e.w]) targetCounts[e.w] = 0;
                var staggerIndex = targetCounts[e.w];
                targetCounts[e.w]++; // Increment for the next label hitting this node

                // Dynamically increase backtracking distance based on index
                var distance = 30 + (staggerIndex * 28);

                var offsetX = p2.x - distance * Math.cos(angle);
                var offsetY = p2.y - distance * Math.sin(angle) - 15;

                d3.select(this).attr("transform", "translate(" + offsetX + "," + offsetY + ")");

                // SVG 'Z-index' trick: append it last so it renders on top
                this.parentNode.appendChild(this);
            }
        });

        function isolate(sys) {
            svg.selectAll(".edgePath, .node, .edgeLabel").classed("fade", true).classed("highlight", false).classed("node-active", false).classed("highlight-label", false);

            let activeEdges = svg.selectAll(".edgePath").filter(function () { return d3.select(this).attr("class").includes(sys); });
            activeEdges.classed("fade", false).classed("highlight", true);

            activeEdges.each(function (d) {
                svg.selectAll(".edgeLabel").filter(l => l.v === d.v && l.w === d.w).classed("fade", false).classed("highlight-label", true);
                d3.select("#node-" + d.v).classed("fade", false).classed("node-active", true);
                d3.select("#node-" + d.w).classed("fade", false).classed("node-active", true);
            });
        }

        function showAll() {
            svg.selectAll(".edgePath, .node, .edgeLabel")
                .classed("fade", false)
                .classed("highlight", false)
                .classed("node-active", false)
                .classed("highlight-label", false);
        }

        var zoom = d3.zoom().on("zoom", () => inner.attr("transform", d3.event.transform));
        svg.call(zoom);
        svg.call(zoom.transform, d3.zoomIdentity.translate(window.innerWidth / 4, 30).scale(0.65));

        function downloadPNG() {
            html2canvas(document.body, { scale: 3, backgroundColor: "#f4f6f9" }).then(canvas => {
                var link = document.createElement('a');
                link.download = 'Bugis_Cleaned_System.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }
    </script>
</body>

</html>